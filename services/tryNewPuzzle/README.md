# tryNewPuzzle

## Description
This API is called by a web page when a user requests to attempt a new puzzle.  When triggered, this service gets a new unsolved puzzle from an S3 bucket.

## Requirements

* AWS CLI already configured with Administrator permission
* [Python 3 installed](https://www.python.org/downloads/)
* Python dependencies, e.g. pytest, boto3, moto.
* [Docker installed](https://www.docker.com/community-edition)
* An S3 bucket with the unsolved puzzles

## Setup process
Create an S3 bucket to store the SAM builds:
```
aws cloudformation create-stack --stack-name sam-builds-trynewpuzzle --template-body file://sam-builds-bucket.yaml
```

## Packaging and deployment
Package our Lambda function to S3:

```
sam package \
    --output-template-file packaged.yaml \
    --s3-bucket sam-builds-trynewpuzzle
```

Create a Cloudformation Stack and deploy your SAM resources.

```
sam deploy \
    --template-file packaged.yaml \
    --stack-name Service-TryNewPuzzle \
    --capabilities CAPABILITY_NAMED_IAM
```

After deployment is complete you can run the following command to retrieve the API Gateway Endpoint URL:
```
aws cloudformation describe-stacks \
    --stack-name Service-TryNewPuzzle \
    --query 'Stacks[].Outputs[?OutputKey==`UnsolvedPuzzleFunctionApi`]' \
    --output table
```

## Fetch, tail, and filter Lambda function logs
Sam logs lets you fetch logs generated by your Lambda function from the command line. (In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.)
```
sam logs -n UnsolvedPuzzleFunction --stack-name Service-TryNewPuzzle --tail
```

## Unit Testing
To execute `pytest` against our `tests` folder to run our initial unit tests:
```
python -m pytest tests/ -v
```

## Local Lambda Testing
Local testing allows you to see how the function will work once deployed, e.g. with memory allocation and timeouts.

1. Build:
    ```
    sam build
    ```
1. Generate test event:
    ```
    sam local generate-event apigateway aws-proxy > events/api_event.json
    ```
1. Invoke Function:
    ```
    sam local invoke --event events/api_event.json
    ```
1. Invoke Function with Name:
    ```
    sam local invoke UnsolvedPuzzleFunction --event events/api_event.json
    ```

## Local API Testing
Local testing of the API, ensures that API and lambda function are correctly configured.
```
sam local start-api
```
Hit the following local endpoint to invoke your function `http://localhost:3000/tryNewPuzzle`

## Cleanup

In order to delete our Serverless Application recently deployed you can use the following AWS CLI Command:

```
aws cloudformation delete-stack --stack-name Service-TryNewPuzzle
```

# Appendix
## SAM and AWS CLI commands

All commands used throughout this document

```
# Generate event.json via generate-event command
sam local generate-event apigateway aws-proxy > event.json

# Invoke function locally with event.json as an input
sam local invoke UnsolvedPuzzleFunction --event event.json

# Run API Gateway locally
sam local start-api

# Package Lambda function defined locally and upload to S3 as an artifact
sam package \
    --output-template-file packaged.yaml \
    --s3-bucket sam-builds-trynewpuzzle

# Deploy SAM template as a CloudFormation stack
sam deploy \
    --template-file packaged.yaml \
    --stack-name Service-TryNewPuzzle \
    --capabilities CAPABILITY_IAM

# Describe Output section of CloudFormation stack previously created
aws cloudformation describe-stacks \
    --stack-name Service-TryNewPuzzle \
    --query 'Stacks[].Outputs[?OutputKey==`UnsolvedPuzzleFunctionApi`]' \
    --output table

# Tail Lambda function Logs using Logical name defined in SAM Template
sam logs -n UnsolvedPuzzleFunction --stack-name Service-TryNewPuzzle --tail

# Deploy the API Manually:
aws apigateway get-rest-apis --query 'items[?name==`Service-GetNewPuzzleSolution`].{name:name, ID:id}'

aws apigateway get-stages --rest-api-id <api-id> --query 'item[?stageName==`Prod`].{stageName:stageName, deploymentId:deploymentId}'

aws apigateway update-stage \
 --rest-api-id <api-id> \
 --stage-name Prod \
 --patch-operations op='replace',path='/deploymentId',value='<deployment-id>'
```
